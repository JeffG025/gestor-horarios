<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horario Digital</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .table-xs { font-size: 0.75rem; }
    </style>
</head>
<body class="p-2">

    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white text-center py-2">
            <h5 class="mb-0 fs-6">ðŸ“… Horario Escolar</h5>
            <small id="lblMaestro" class="text-warning">Cargando...</small>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered table-striped text-center table-xs mb-0">
                <thead class="table-secondary">
                    <tr><th>Hr</th><th>Lun</th><th>Mar</th><th>MiÃ©</th><th>Jue</th><th>Vie</th></tr>
                </thead>
                <tbody id="tablaCuerpo">
                    <tr><td colspan="6">Cargando datos...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="card-footer text-center">
            <small class="text-muted" style="font-size: 10px;">Gestor de Horarios v1.0</small>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // 1. Obtener ID del maestro desde la URL
            const params = new URLSearchParams(window.location.search);
            const idMaestro = params.get('id');
            const nombreMaestro = params.get('nombre');

            if(nombreMaestro) {
                document.getElementById('lblMaestro').innerText = nombreMaestro;
            }

            // 2. Generar tabla vacÃ­a (7am - 3pm)
            const generarTabla = () => {
                const horas = [7, 8, 9, 10, 11, 12, 13, 14];
                let html = '';
                horas.forEach(h => {
                    const horaF = `${h.toString().padStart(2, '0')}:00`;
                    html += `<tr>
                        <td class="fw-bold bg-light">${horaF}</td>
                        <td id="cell-Lunes-${h}"></td>
                        <td id="cell-Martes-${h}"></td>
                        <td id="cell-Miercoles-${h}"></td>
                        <td id="cell-Jueves-${h}"></td>
                        <td id="cell-Viernes-${h}"></td>
                    </tr>`;
                });
                document.getElementById('tablaCuerpo').innerHTML = html;
            };

            // 3. Cargar datos (CON CORRECCIÃ“N PARA NGROK)
            const cargarHorario = async () => {
                if(!idMaestro) {
                    alert("No se especificÃ³ un maestro.");
                    return;
                }

                try {
                    console.log("Solicitando datos...");
                    
                    // AQUÃ ESTÃ EL TRUCO: Headers especiales para Ngrok
                    const res = await fetch(`/api/horario/maestro/${idMaestro}`, {
                        method: 'GET',
                        headers: new Headers({
                            "ngrok-skip-browser-warning": "69420", // Esta lÃ­nea evita el bloqueo
                            "Content-Type": "application/json"
                        })
                    });

                    if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);

                    const clases = await res.json();
                    console.log("Datos recibidos:", clases);

                    // Si llegamos aquÃ­, pintamos la tabla
                    generarTabla(); // Limpiar primero

                    if (clases.length === 0) {
                        alert("Este maestro no tiene clases asignadas aÃºn.");
                    }
                    
                    clases.forEach(clase => {
                        const horaBase = parseInt(clase.hora_inicio.split(':')[0]);
                        const celda = document.getElementById(`cell-${clase.dia_semana}-${horaBase}`);
                        
                        if (celda) {
                            celda.innerHTML = `<b class="d-block text-truncate">${clase.asignatura}</b><span class="badge bg-success">${clase.nombre_aula}</span>`;
                            celda.classList.add('table-success'); 
                        }
                    });

                } catch (error) {
                    console.error(error);
                    document.getElementById('tablaCuerpo').innerHTML = `<tr><td colspan="6" class="text-danger">Error cargando datos: ${error.message}</td></tr>`;
                }
            };

            // Iniciar
            generarTabla(); // Generar estructura visual primero
            cargarHorario(); // Luego buscar datos
        });
    </script>
</body>
</html>