<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Subdirector | Gesti√≥n de Usuarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-danger mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">üëÆ‚Äç‚ôÇÔ∏è Subdirecci√≥n Acad√©mica</span>
            <button onclick="cerrarSesion()" class="btn btn-outline-light btn-sm">Cerrar Sesi√≥n</button>
        </div>
    </nav>

    <div class="container">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-danger">Gesti√≥n de Personal</h4>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalNuevoUsuario">
                ‚ûï Agregar Nuevo Usuario
            </button>
        </div>

        <div class="card shadow">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Correo</th>
                                <th>Rol</th>
                                <th>Contrato</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaUsuarios">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalNuevoUsuario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Registrar Nuevo Personal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formRegistro">
                        <div class="mb-3">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" id="nombre" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Correo Electr√≥nico</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contrase√±a</label>
                            <input type="password" id="password" class="form-control" required minlength="6">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Categor√≠a (Rol)</label>
                            <select id="rol" class="form-select" required>
                                <option value="maestro">Docente</option>
                                <option value="jefe">Jefe de Departamento</option>
                                <option value="subdirectivo">Subdirector Acad√©mico</option>
                            </select>
                        </div>

<div class="row" id="divContrato">
    <div class="col-6 mb-3">
        <label class="form-label">Contrato</label>
        <select id="tipo_contrato" class="form-select">
            <option value="asignatura">Asignatura</option>
            <option value="medio_tiempo">Medio Tiempo</option>
            <option value="tiempo_completo">Tiempo Completo</option>
        </select>
    </div>
    <div class="col-6 mb-3">
        <label class="form-label">Horas Semanales</label>
        <input type="number" id="horas" class="form-control" value="0">
    </div>
</div>

                        <button type="submit" class="btn btn-success w-100">Crear Usuario</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 1. SEGURIDAD
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (!usuario || usuario.rol !== 'subdirectivo') {
            window.location.href = '/';
        }

        // 2. CARGAR USUARIOS
        async function cargarUsuarios() {
            const res = await fetch('/api/usuarios');
            const lista = await res.json();
            const tbody = document.getElementById('tablaUsuarios');
            tbody.innerHTML = '';

            lista.forEach(u => {
                const esElMismo = u.id === usuario.id;
                const btnBorrar = esElMismo 
                    ? '' 
                    : `<button onclick="eliminarUsuario(${u.id}, '${u.nombre}')" class="btn btn-outline-danger btn-sm">üóëÔ∏è</button>`;

                // Colores para roles
                let badgeColor = 'bg-primary'; // Maestro
                if (u.rol === 'jefe') badgeColor = 'bg-dark';
                if (u.rol === 'subdirectivo') badgeColor = 'bg-danger';

                // Texto bonito para el rol
                let rolTexto = u.rol.charAt(0).toUpperCase() + u.rol.slice(1);

                tbody.innerHTML += `
                    <tr>
                        <td>${u.nombre}</td>
                        <td><small>${u.email}</small></td>
                        <td><span class="badge ${badgeColor}">${rolTexto}</span></td>
                        <td><small>${u.tipo_contrato}</small></td>
                        <td class="text-end">${btnBorrar}</td>
                    </tr>
                `;
            });
        }

        // 3. CREAR NUEVO USUARIO (Conexi√≥n al Backend)
        document.getElementById('formRegistro').addEventListener('submit', async (e) => {
            e.preventDefault();

            const datos = {
                nombre: document.getElementById('nombre').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                rol: document.getElementById('rol').value,
                tipo_contrato: document.getElementById('tipo_contrato').value,
                horas: document.getElementById('horas').value
            };

            if(!confirm(`¬øConfirma crear un usuario tipo ${datos.rol.toUpperCase()}?`)) return;

            try {
                // Reutilizamos la ruta de crear maestro, ahora mejorada para aceptar roles
                const res = await fetch('/api/crear-maestro', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                
                const resultado = await res.json();

                if(res.ok) {
                    alert("‚úÖ Usuario creado exitosamente");
                    // Cerrar modal y recargar tabla
                    const modalElement = document.getElementById('modalNuevoUsuario');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    modal.hide();
                    document.getElementById('formRegistro').reset();
                    cargarUsuarios();
                } else {
                    alert("‚ùå Error: " + (resultado.mensaje || "Error desconocido"));
                }
            } catch (error) {
                console.error(error);
                alert("Error de conexi√≥n");
            }
        });

        // 4. ELIMINAR USUARIO
        async function eliminarUsuario(id, nombre) {
            if(!confirm(`‚ö†Ô∏è ¬øEliminar a ${nombre}? Esta acci√≥n es irreversible.`)) return;
            const res = await fetch(`/api/usuarios/${id}`, { method: 'DELETE' });
            if(res.ok) cargarUsuarios();
            else alert("Error al eliminar");
        }

        function cerrarSesion() {
            localStorage.removeItem('usuario');
            window.location.href = '/';
        }

        cargarUsuarios();

        // --- L√ìGICA PARA OCULTAR/MOSTRAR CONTRATO ---
    const selectRol = document.getElementById('rol');
    const divContrato = document.getElementById('divContrato');

    // Funci√≥n que decide si mostrar u ocultar
    function alternarCamposContrato() {
        if (selectRol.value === 'maestro') {
            divContrato.style.display = 'flex'; // Mostrar si es docente
        } else {
            divContrato.style.display = 'none'; // Ocultar si es Jefe o Subdirector
            // Opcional: Reiniciar horas a 0 para que no se guarde basura
            document.getElementById('horas').value = 0; 
        }
    }

    // Ejecutar cuando el usuario cambie la opci√≥n
    selectRol.addEventListener('change', alternarCamposContrato);

    // Ejecutar al inicio por si acaso
    alternarCamposContrato();
    </script>
</body>
</html>