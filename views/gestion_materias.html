<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Materias</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">üìö Gesti√≥n de Materias</span>
            <div>
                <a href="/asignar-clase" class="btn btn-light btn-sm me-2">‚¨Ö Volver a Horarios</a>
                <button onclick="cerrarSesion()" class="btn btn-dark btn-sm">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card shadow">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary">Cat√°logo de Asignaturas</h5>
                <button class="btn btn-success btn-sm" onclick="abrirModalCrear()">
                    ‚ûï Nueva Materia
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 text-center">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Semestre</th>
                                <th>Cr√©ditos / Horas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaMaterias">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalMateria" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="tituloModal">Nueva Materia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formMateria">
                        <input type="hidden" id="idMateria"> 
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nombre de la Asignatura</label>
                            <input type="text" id="nombre" class="form-control" required placeholder="Ej: C√°lculo Integral">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Semestre</label>
                                <select id="semestre" class="form-select" required>
                                    <option value="1">1er Semestre</option>
                                    <option value="2">2do Semestre</option>
                                    <option value="3">3ro Semestre</option>
                                    <option value="4">4to Semestre</option>
                                    <option value="5">5to Semestre</option>
                                    <option value="6">6to Semestre</option>
                                    <option value="7">7mo Semestre</option>
                                    <option value="8">8vo Semestre</option>
                                    <option value="9">9no Semestre</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Cr√©ditos</label>
                                <input type="number" id="creditos" class="form-control" required min="1" max="10" placeholder="Ej: 5">
                            </div>
                        </div>
                        
                        <div class="alert alert-info small p-2">
                            <strong>üìã Reglas de Horario Autom√°tico:</strong>
                            <ul class="mb-0 ps-3" style="font-size: 0.85rem;">
                                <li><strong>4 Cr√©ditos:</strong> Lun-Jue (1 hr).</li>
                                <li><strong>5 Cr√©ditos:</strong> Lun-Vie (1 hr).</li>
                                <li><strong>6 Cr√©ditos:</strong> Lun-Jue (1 hr) y Vie (2 hrs).</li>
                                <li><strong>10 Cr√©ditos:</strong> Lun-Vie (2 hrs diarias).</li>
                            </ul>
                        </div>

                        <button type="submit" class="btn btn-success w-100 fw-bold">Guardar Materia</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. SEGURIDAD
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (!usuario || (usuario.rol !== 'jefe' && usuario.rol !== 'subdirectivo')) {
            window.location.href = '/';
        }

        const modal = new bootstrap.Modal(document.getElementById('modalMateria'));
        let modoEdicion = false;

        // 2. CARGAR MATERIAS
        async function cargarMaterias() {
            try {
                // Aseg√∫rate que esta ruta coincide con tu backend (asignaturaController.listar)
                const res = await fetch('/api/asignaturas'); 
                const lista = await res.json();
                
                const tbody = document.getElementById('tablaMaterias');
                tbody.innerHTML = '';

                lista.forEach(m => {
                    tbody.innerHTML += `
                        <tr>
                            <td class="fw-bold text-start ps-4">${m.nombre}</td>
                            <td><span class="badge bg-warning text-dark">Sem ${m.semestre || '?'}</span></td>
                            <td><span class="badge bg-info text-dark">${m.creditos} Cr</span></td>
                            <td>
                                <button onclick="abrirModalEditar(${m.id}, '${m.nombre}', ${m.creditos}, ${m.semestre})" class="btn btn-outline-primary btn-sm me-1">‚úèÔ∏è</button>
                                <button onclick="eliminarMateria(${m.id})" class="btn btn-outline-danger btn-sm">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error cargando materias:", error);
            }
        }

        // 3. ABRIR MODAL CREAR
        function abrirModalCrear() {
            modoEdicion = false;
            document.getElementById('tituloModal').innerText = "Nueva Materia";
            document.getElementById('formMateria').reset();
            document.getElementById('idMateria').value = '';
            document.getElementById('semestre').value = '1'; // Default
            modal.show();
        }

        // 4. ABRIR MODAL EDITAR (Ahora recibe semestre)
        function abrirModalEditar(id, nombre, creditos, semestre) {
            modoEdicion = true;
            document.getElementById('tituloModal').innerText = "Editar Materia";
            document.getElementById('idMateria').value = id;
            document.getElementById('nombre').value = nombre;
            document.getElementById('creditos').value = creditos;
            document.getElementById('semestre').value = semestre; // Carga el semestre
            modal.show();
        }

        // 5. GUARDAR (Crear o Editar)
        document.getElementById('formMateria').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('idMateria').value;
            const nombre = document.getElementById('nombre').value;
            const creditos = document.getElementById('creditos').value;
            const semestre = document.getElementById('semestre').value;

            const datos = { id, nombre, creditos, semestre };

            // Usamos las rutas espec√≠ficas que definimos en el paso anterior para asegurar compatibilidad
            const url = modoEdicion ? '/api/editar-materia' : '/api/crear-materia';

            try {
                const res = await fetch(url, {
                    method: 'POST', // Usamos POST para ambos seg√∫n tu controlador anterior
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const respuesta = await res.json();

                if(respuesta.exito) {
                    modal.hide();
                    cargarMaterias();
                } else {
                    alert("Error: " + respuesta.mensaje);
                }
            } catch (error) {
                console.error(error);
                alert("Error de conexi√≥n al guardar.");
            }
        });

        // 6. ELIMINAR
        async function eliminarMateria(id) {
            if(!confirm("‚ö†Ô∏è ¬øEliminar materia? Se borrar√°n todos los horarios asignados a ella.")) return;
            
            // Ajusta esta ruta si tu backend usa /api/eliminar-materia en lugar de DELETE
            // Si usas el controlador est√°ndar REST: `/api/asignaturas/${id}`
            // Si usas el controlador personalizado: `/api/eliminar-materia/${id}`
            const res = await fetch(`/api/asignaturas/${id}`, { method: 'DELETE' });
            
            if(res.ok) cargarMaterias();
            else alert("Error al eliminar (quiz√°s tiene horarios asignados).");
        }

        function cerrarSesion() {
            localStorage.removeItem('usuario');
            window.location.href = '/';
        }

        // Iniciar
        cargarMaterias();
    </script>
</body>
</html>