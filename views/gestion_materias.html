<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Materias</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">üìö Gesti√≥n de Materias</span>
            <div>
                <a href="/asignar-clase" class="btn btn-light btn-sm me-2">‚¨Ö Volver a Horarios</a>
                <button onclick="cerrarSesion()" class="btn btn-dark btn-sm">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card shadow">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary">Cat√°logo de Asignaturas</h5>
                <button class="btn btn-success btn-sm" onclick="abrirModalCrear()">
                    ‚ûï Nueva Materia
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 text-center">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Horas Semanales</th>
                                <th>Cr√©ditos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaMaterias">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalMateria" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="tituloModal">Nueva Materia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
<div class="modal-body">
                    <form id="formMateria">
                        <input type="hidden" id="idMateria"> <div class="mb-3">
                            <label class="form-label">Nombre de la Asignatura</label>
                            <input type="text" id="nombre" class="form-control" required placeholder="Ej: C√°lculo Integral">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">N√∫mero de Cr√©ditos (Valor Curricular)</label>
                            <input type="number" id="creditos" class="form-control" required min="1" max="10" placeholder="Ej: 5">
                            <div class="form-text">Las horas semanales ser√°n iguales a los cr√©ditos.</div>
                        </div>
                        
<div class="alert alert-info small p-2">
    <strong>üìã Reglas de Horario Autom√°tico:</strong>
    <ul class="mb-0 ps-3" style="font-size: 0.85rem;">
        <li><strong>4 Cr√©ditos:</strong> Lun-Jue (1 hr).</li>
        <li><strong>5 Cr√©ditos:</strong> Lun-Vie (1 hr).</li>
        <li><strong>6 Cr√©ditos:</strong> Lun-Jue (1 hr) y Vie (2 hrs).</li>
        <li><strong>7 Cr√©ditos:</strong> Lun-Mi√© (1 hr) y Jue-Vie (2 hrs).</li>
        <li><strong>8 Cr√©ditos:</strong> Lun-Mar (1 hr) y Mie-Vie (2 hrs).</li>
        <li><strong>9 Cr√©ditos:</strong> Lun-Mar (1 hr) y Mie-Vie (2 hrs).</li>
        <li><strong>10 Cr√©ditos:</strong> Lun-Vie (2 hrs diarias).</li>
    </ul>
</div>

                        <button type="submit" class="btn btn-success w-100">Guardar Materia</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. SEGURIDAD
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (!usuario || usuario.rol !== 'jefe') {
            window.location.href = '/';
        }

        const modal = new bootstrap.Modal(document.getElementById('modalMateria'));
        let modoEdicion = false;

        // 2. CARGAR MATERIAS
        async function cargarMaterias() {
            const res = await fetch('/api/asignaturas'); // Usamos la ruta que ya exist√≠a o la nueva
            const lista = await res.json();
            // Si la ruta devolvi√≥ un objeto {maestros, aulas...} (la vieja), ajustamos.
            // Pero como creamos una ruta /api/asignaturas espec√≠fica en el controller nuevo, debe devolver array directo.
            // Si da error, verifica que en rutas.js '/api/asignaturas' apunte a asignaturaController.listar
            
            const tbody = document.getElementById('tablaMaterias');
            tbody.innerHTML = '';

            lista.forEach(m => {
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-start ps-4">${m.nombre}</td>
                        <td><span class="badge bg-info text-dark">${m.creditos}</span></td>
                        <td>
                            <button onclick="abrirModalEditar(${m.id}, '${m.nombre}', ${m.creditos})" class="btn btn-outline-primary btn-sm me-1">‚úèÔ∏è</button>
                            <button onclick="eliminarMateria(${m.id})" class="btn btn-outline-danger btn-sm">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        }

        // 3. FUNCIONES DEL MODAL
        function abrirModalCrear() {
            modoEdicion = false;
            document.getElementById('tituloModal').innerText = "Nueva Materia";
            document.getElementById('formMateria').reset();
            document.getElementById('idMateria').value = '';
            modal.show();
        }

        function abrirModalEditar(id, nombre, horas, creditos) {
            modoEdicion = true;
            document.getElementById('tituloModal').innerText = "Editar Materia";
            document.getElementById('idMateria').value = id;
            document.getElementById('nombre').value = nombre;
            // document.getElementById('horas').value = horas; // <-- ESTO YA NO EXISTE
            document.getElementById('creditos').value = creditos;
            modal.show();
        }

        // GUARDAR (Actualizado)
        document.getElementById('formMateria').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const valCreditos = document.getElementById('creditos').value;

            const datos = {
                id: document.getElementById('idMateria').value,
                nombre: document.getElementById('nombre').value,
                creditos: valCreditos,
                horas: valCreditos // <--- TRUCO: Las horas ser√°n igual a los cr√©ditos
            };

            const url = '/api/asignaturas';
            const metodo = modoEdicion ? 'PUT' : 'POST';

            const res = await fetch(url, {
                method: metodo,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });

            if(res.ok) {
                modal.hide();
                cargarMaterias();
            } else {
                alert("Error al guardar");
            }
        });

        // 5. ELIMINAR
        async function eliminarMateria(id) {
            if(!confirm("‚ö†Ô∏è ¬øEliminar materia? Se borrar√°n todos los horarios asignados a ella.")) return;
            
            const res = await fetch(`/api/asignaturas/${id}`, { method: 'DELETE' });
            if(res.ok) cargarMaterias();
            else alert("Error al eliminar");
        }

        function cerrarSesion() {
            localStorage.removeItem('usuario');
            window.location.href = '/';
        }

        cargarMaterias();
    </script>
</body>
</html>